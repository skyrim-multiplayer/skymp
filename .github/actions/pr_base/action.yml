name: PR Base
inputs:
  DESCRIPTION:
    description: "Will be used for artifact names"
    required: true
  SKYRIM_VR_FLAG:
    description: "Set to ON if building for Skyrim VR"
    required: false
    default: OFF
  SP_NEXUS_ARTIFACT_NAME:
    description: "May be nope. Artifact name for Skyrim Platform Nexus artifact, %SP_VERSION% will be replaced with the version number"
    required: false
    default: "nope"
  DEPLOY_BRANCH:
    description: "May be empty. Branch here refers to indev/sweetpie"
    required: false
    default: ""
  DIST_ARTIFACT_NAME:
    description: "Artifact name for the dist folder"
    required: true
  SERVER_DIST_ARTIFACT_NAME:
    description: "Artifact name for the server dist folder"
    required: true
  SKYMP5_PATCHES_PAT:
    description: "PAT for skymp5-patches repository"
    required: true
  SKYMP5_FRONT_PAT:
    description: "PAT for skymp5-front repository"
    required: false
  BUILD_SKYMP5_FRONT:
    description: "Set to true if building skymp5-front"
    required: false
    default: "false"
  NUGET_GITHUB_TOKEN:
    description: "A GitHub token for GitHub Packages (Nuget)"
    required: false
    default: ""
  EMSCRIPTEN:
    description: "Set to true if building for Emscripten"
    required: false
    default: "false"
runs:
  using: composite
  steps:  
    - name: Gather PRs
      if: ${{ inputs.DEPLOY_BRANCH != '' }}
      uses: Pospelove/auto-merge-action@main
      with:
        path: ${{github.workspace}}
        generate-build-metadata: true
        repositories: |
          [
            {
              "owner": "skyrim-multiplayer",
              "repo": "skymp",
              "labels": ["merge-to:${{inputs.DEPLOY_BRANCH}}"]
            },
            {
              "owner": "skyrim-multiplayer",
              "repo": "skymp5-patches",
              "labels": ["merge-to:${{inputs.DEPLOY_BRANCH}}"],
              "token": "${{inputs.SKYMP5_PATCHES_PAT}}"
            }
          ]
    
    - name: Get Git SHA Before Gather
      id: repo_sha
      uses: actions/github-script@v6
      with:
        script: |
          const { execSync } = require('child_process');
          const sha = execSync('git rev-parse HEAD', { encoding: 'utf8' }).trim();
          core.exportVariable('sha', sha);

    - name: Commit gathered PRs
      if: ${{ inputs.DEPLOY_BRANCH != '' }}
      uses: actions/github-script@v6
      with:
        script: |
          const { execSync } = require('child_process');
          
          // fake user for bot
          execSync('git config --global user.email "skyrim_multiplayer_bot@users.noreply.github.com"');
          execSync('git config --global user.name "Skyrim Multiplayer Bot"');
          execSync('git add .');
          execSync('git commit -m "Merge PRs ${{inputs.DEPLOY_BRANCH}}"');

    - name: Early build skymp5-client
      uses: actions/github-script@v6
      with:
        script: |
          const { execSync } = require('child_process');
          const path = require('path');
          
          const clientPath = path.join('${{github.workspace}}', 'skymp5-client');
          execSync('yarn', { cwd: clientPath, stdio: 'inherit' });
          execSync('yarn build', { cwd: clientPath, stdio: 'inherit' });

    - name: Check and install OpenCppCoverage using github-script
      if: runner.os == 'Windows'
      uses: actions/github-script@v6
      with:
        script: |
          const { execSync } = require('child_process');
          const fs = require('fs');

          const coveragePath = 'C:\\Program Files\\OpenCppCoverage\\OpenCppCoverage.exe';

          if (fs.existsSync(coveragePath)) {
            console.log('OpenCppCoverage is already installed.');
          } else {
            try {
              execSync('choco --version', { stdio: 'ignore' });
            } catch (error) {
              core.setFailed('OpenCppCoverage not found, and choco is missing.');
              return;
            }

            try {
              console.log('Installing OpenCppCoverage using choco...');
              execSync('choco install opencppcoverage -y', { stdio: 'inherit' });
            } catch (installError) {
              core.setFailed(`Failed to install OpenCppCoverage: ${installError.message}`);
            }
          }

    - name: Move vcpkg submodule to a larger drive using github-script
      if: runner.os == 'Windows'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const fsp = fs.promises;
          const path = require('path');

          const targetPath = 'C:\\vcpkg';
          const sourcePath = path.join(process.env.GITHUB_WORKSPACE, 'vcpkg');

          async function moveWithFallback(sourcePath_, targetPath_) {
            try {
              await fsp.rename(sourcePath_, targetPath_);
            } catch (err) {
              if (err.code === 'EXDEV') {
                console.log('Falling back to copy and delete due to cross-device link error.');
                await fsp.cp(sourcePath_, targetPath_, { recursive: true });
                await fsp.rm(sourcePath_, { recursive: true, force: true });
              }
              else {
                throw err;
              }
            }
          }

          async function moveVcpkg() {
            try {
              if (fs.existsSync(targetPath)) {
                console.log(`Removing existing ${targetPath}...`);
                await fsp.rm(targetPath, { recursive: true, force: true });
              }

              console.log(`Moving ${sourcePath} to ${targetPath}...`);
              await moveWithFallback(sourcePath, targetPath);
              console.log(`Successfully moved vcpkg to ${targetPath}`);
            } catch (err) {
              core.setFailed(`Error moving vcpkg: ${err.message}`);
            }
          }
          await moveVcpkg();

    - name: Bootstrap vcpkg (Windows)
      if: runner.os == 'Windows'
      run: C:/vcpkg/bootstrap-vcpkg.bat
      shell: powershell

    - name: Bootstrap vcpkg (Non-Windows)
      if: runner.os != 'Windows'
      run: ./vcpkg/bootstrap-vcpkg.sh
      shell: bash

    - name: Debug - free space
      if: runner.os == 'Windows'
      uses: actions/github-script@v6
      with:
        script: |
          const { execSync } = require('child_process');
          const output = execSync('Get-PSDrive', { encoding: 'utf8', shell: 'powershell' });
          console.log(output);

    - uses: actions/github-script@v6
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Setup NuGet Credentials
      if: runner.os == 'Windows'
      uses: actions/github-script@v6
      with:
        script: |
          const { execSync } = require('child_process');
          
          const vcpkgBinarySources = process.env.VCPKG_BINARY_SOURCES || '';
          if (!vcpkgBinarySources.includes('nuget')) {
            console.log('Skipping NuGet setup because VCPKG_BINARY_SOURCES does not contain "nuget".');
            return;
          }

          const nugetPath = execSync('C:\\vcpkg\\vcpkg.exe fetch nuget', { encoding: 'utf8' })
            .trim().split('\n').pop();

          const eventName = '${{ github.event_name }}';
          const actor = '${{ github.actor }}';
          const token = '${{ inputs.NUGET_GITHUB_TOKEN }}';
          
          if (eventName === 'pull_request') {
            console.log('Pull request detected. Adding NuGet source for actor.');
            execSync(`"${nugetPath}" sources add -source "https://nuget.pkg.github.com/${actor}/index.json" -storepasswordincleartext -name "GitHub" -username "${actor}" -password "${token}"`);
          } else {
            console.log('Non-pull request event detected. Adding default NuGet source.');
            execSync(`"${nugetPath}" sources add -source "https://nuget.pkg.github.com/skyrim-multiplayer/index.json" -storepasswordincleartext -name "GitHub" -username "skyrim-multiplayer" -password "${token}"`);
          }

    # Download Skyrim SE data files
    - uses: suisei-cn/actions-download-file@v1
      name: Download Skyrim.esm
      with:
        url: "https://gitlab.com/pospelov/se-data/-/raw/main/Skyrim.esm"
        target: ${{github.workspace}}/skyrim_data_files/
    - uses: suisei-cn/actions-download-file@v1
      name: Download Update.esm
      with:
        url: "https://gitlab.com/pospelov/se-data/-/raw/main/Update.esm"
        target: ${{github.workspace}}/skyrim_data_files/
    - uses: suisei-cn/actions-download-file@v1
      name: Download Dawnguard.esm
      with:
        url: "https://gitlab.com/pospelov/se-data/-/raw/main/Dawnguard.esm"
        target: ${{github.workspace}}/skyrim_data_files/
    - uses: suisei-cn/actions-download-file@v1
      name: Download HearthFires.esm
      with:
        url: "https://gitlab.com/pospelov/se-data/-/raw/main/HearthFires.esm"
        target: ${{github.workspace}}/skyrim_data_files/
    - uses: suisei-cn/actions-download-file@v1
      name: Download Dragonborn.esm
      with:
        url: "https://gitlab.com/pospelov/se-data/-/raw/main/Dragonborn.esm"
        target: ${{github.workspace}}/skyrim_data_files/

    - name: Configure CMake
      # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
      # Outputs profiling data in Google Trace Format, which can be parsed by the about:tracing tab of Google Chrome or using a plugin for a tool like Trace Compass.
      uses: actions/github-script@v6
      with:
        script: |
          const { execSync } = require('child_process');
          const path = require('path');
          
          const isEmscripten = '${{ inputs.EMSCRIPTEN }}' === 'true';
          const isWindows = process.platform === 'win32';
          
          // Setup Emscripten if needed
          let env = process.env;
          if (isEmscripten) {
            console.log('Setting up Emscripten...');
            execSync('git clone --depth 1 https://github.com/emscripten-core/emsdk.git', { stdio: 'inherit' });
            
            const emsdkPath = path.join(process.cwd(), 'emsdk');
            execSync('./emsdk install 3.1.64', { cwd: emsdkPath, stdio: 'inherit' });
            execSync('./emsdk activate 3.1.64', { cwd: emsdkPath, stdio: 'inherit' });
            
            // Get Emscripten environment variables
            const emsdkEnvPath = path.join(emsdkPath, 'upstream', 'emscripten');
            
            // Set up environment for Emscripten
            env = { ...process.env };
            env.EMSDK = emsdkPath;
            env.EMSDK_NODE = path.join(emsdkPath, 'node', '22.16.0_64bit', 'bin', 'node');
            env.PATH = `${emsdkPath}:${emsdkEnvPath}:${env.PATH}`;
            
            console.log('Emscripten environment configured:');
            console.log('EMSDK:', env.EMSDK);
            console.log('EMSDK_NODE:', env.EMSDK_NODE);
            console.log('PATH includes:', `${emsdkPath}:${emsdkEnvPath}`);
          }

          // Build CMake command
          const cmakeCommand = isEmscripten ? 'emcmake cmake' : 'cmake';
          
          // Determine arguments based on platform and configuration
          const cppcovPathArg = isWindows ? '-DCPPCOV_PATH="C:\\Program Files\\OpenCppCoverage"' : '-DCPPCOV_PATH=OFF';
          const vcpkgRootArg = isWindows ? '-DVCPKG_ROOT=C:/vcpkg' : '-DVCPKG_ROOT=${{github.workspace}}/vcpkg';
          const vcpkgChainloadArg = isEmscripten ? '-DVCPKG_CHAINLOAD_TOOLCHAIN_FILE=${{github.workspace}}/emsdk/upstream/emscripten/cmake/Modules/Platform/Emscripten.cmake' : '';
          const vcpkgTripletArg = isEmscripten ? '-DVCPKG_TARGET_TRIPLET=wasm32-emscripten' : '';
          const prepareNexusArg = '${{ inputs.SP_NEXUS_ARTIFACT_NAME}}' === 'nope' ? '-DPREPARE_NEXUS_ARCHIVES=OFF' : '-DPREPARE_NEXUS_ARCHIVES=ON';

          // Build the full command
          let cmakeArgs = [
            '-B ${{github.workspace}}/build',
            vcpkgChainloadArg,
            vcpkgTripletArg,
            vcpkgRootArg,
            '-DUNIT_DATA_DIR=skyrim_data_files',
            '-DBUILD_NODEJS=OFF',
            '-DBUILD_FRONT=${{ inputs.BUILD_SKYMP5_FRONT }}',
            '-DSKYMP5_FRONT_REPO_PAT=${{ inputs.SKYMP5_FRONT_PAT }}',
            prepareNexusArg,
            '-DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}',
            '-DSKYRIM_VR=${{ inputs.SKYRIM_VR_FLAG }}',
            cppcovPathArg,
            '--profiling-output cmake-profiling-output',
            '--profiling-format google-trace'
          ].filter(arg => arg !== ''); // Remove empty args

          const fullCommand = `${cmakeCommand} ${cmakeArgs.join(' ')}`;
          console.log(`Executing: ${fullCommand}`);
          
          execSync(fullCommand, { stdio: 'inherit', env: env });

    - name: Upload vcpkg logs (non-Windows)
      if: ${{ always() && runner.os != 'Windows' }}
      uses: actions/upload-artifact@v4
      with:
        name: vcpkg_logs
        path: |
          ${{github.workspace}}/build/vcpkg-bootstrap.log
          ${{github.workspace}}/vcpkg/buildtrees/**/*.log

    # actions/upload-artifact will not work for C:/vcpkg because it's not under github.workspace
    - name: Prepare vcpkg logs (Windows)
      if: ${{ always() && runner.os == 'Windows' }}
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          const logDir = path.join('${{ github.workspace }}', 'vcpkg_logs');
          const sourceDir = 'C:\\vcpkg\\buildtrees';

          // Create log directory
          if (!fs.existsSync(logDir)) {
            fs.mkdirSync(logDir, { recursive: true });
          }

          // Function to recursively find .log files
          function findLogFiles(dir) {
            const files = [];
            const items = fs.readdirSync(dir, { withFileTypes: true });
            
            for (const item of items) {
              const fullPath = path.join(dir, item.name);
              if (item.isDirectory()) {
                files.push(...findLogFiles(fullPath));
              } else if (item.isFile() && item.name.endsWith('.log')) {
                files.push(fullPath);
              }
            }
            
            return files;
          }

          // Copy log files
          if (fs.existsSync(sourceDir)) {
            const logFiles = findLogFiles(sourceDir);
            
            for (const logFile of logFiles) {
              const relativePath = path.relative(sourceDir, logFile);
              const destinationPath = path.join(logDir, relativePath);
              
              // Create destination directory
              const destinationDir = path.dirname(destinationPath);
              if (!fs.existsSync(destinationDir)) {
                fs.mkdirSync(destinationDir, { recursive: true });
              }
              
              // Copy file
              fs.copyFileSync(logFile, destinationPath);
            }
          }


    - name: Upload vcpkg logs (Windows)
      if: ${{ always() && runner.os == 'Windows' }}
      uses: actions/upload-artifact@v4
      with:
        name: vcpkg_logs
        path: |
          ${{github.workspace}}/build/vcpkg-bootstrap.log
          ${{github.workspace}}/vcpkg_logs

    - uses: actions/upload-artifact@v4
      with:
        name: cmake-profiling-output (${{ inputs.DESCRIPTION }})
        path: cmake-profiling-output

    - name: Build
      # Build your program with the given configuration
      uses: actions/github-script@v6
      with:
        script: |
          const { execSync } = require('child_process');
          execSync('cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}', { stdio: 'inherit' });

    # before running tests, because of dist check test
    - name: Compile metadata into public format
      if: ${{ runner.os == 'Windows' }}
      uses: actions/github-script@v6
      with:
        script: |
          const deployBranch = "${{ inputs.DEPLOY_BRANCH }}";
          const fs = require('fs');
          const crypto = require('crypto');

          const res = {};

          res.commitSha = process.env.GITHUB_SHA;

          if (deployBranch !== '') {
            const file = fs.readFileSync('./build-metadata.json');
            const data = JSON.parse(file);

            res.refs_info = data.refs_info.map((refInfo) => {
              if (refInfo.repoName !== "skymp5-patches") {
                return refInfo;
              }
              else {
                return { 
                  refInfoHash: crypto.createHash('sha256').update(refInfo.ref).digest('hex'),
                  lastCommitSha: refInfo.lastCommitSha,
                  prNumber: refInfo.prNumber
                };
              }
            });
          }

          console.log("Resulting data:");
          console.log(res);

          const outFilePath = './build/dist/client/Data/Platform/Distribution/build-metadata-public.json';
          fs.writeFileSync(outFilePath, JSON.stringify(res, null, 2));

    - name: Test
      # Execute tests defined by the CMake configuration.  
      # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail
      uses: actions/github-script@v6
      with:
        script: |
          const { execSync } = require('child_process');
          const path = require('path');
          
          const buildDir = path.join('${{github.workspace}}', 'build');
          execSync('ctest -C ${{env.BUILD_TYPE}} --verbose', { 
            cwd: buildDir, 
            stdio: 'inherit' 
          });

    - uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.DIST_ARTIFACT_NAME }}
        path: ${{github.workspace}}/build/dist

    - uses: actions/upload-artifact@v4
      with:
        name: skymp5-client-js (${{ inputs.DESCRIPTION }})
        path: ${{github.workspace}}/build/dist/client/Data/Platform/Plugins/skymp5-client.js

    - uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.SERVER_DIST_ARTIFACT_NAME }}
        path: ${{github.workspace}}/build/dist/server

    - uses: actions/upload-artifact@v4
      with:
        name: coverage (${{ inputs.DESCRIPTION }})
        path: ${{github.workspace}}/build/__coverage

    - name: Extract SP Version Number
      if: ${{ inputs.SP_NEXUS_ARTIFACT_NAME != 'nope' }}
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const packageJson = JSON.parse(fs.readFileSync('./skyrim-platform/package.json', 'utf8'));
          const version = packageJson.version;
          core.exportVariable('VERSION', version);

    - name: Replace %SP_VERSION% with actual version in artifact name
      if: ${{ inputs.SP_NEXUS_ARTIFACT_NAME != 'nope' }}
      uses: actions/github-script@v6
      with:
        script: |
          let artifactName = '${{ inputs.SP_NEXUS_ARTIFACT_NAME }}';
          artifactName = artifactName.replace('%SP_VERSION%', '${{ env.VERSION }}');
          core.exportVariable('SP_NEXUS_ARTIFACT_NAME', artifactName);
      
    - uses: actions/upload-artifact@v4
      if: ${{ inputs.SP_NEXUS_ARTIFACT_NAME != 'nope' }}
      with:
        name: ${{ env.SP_NEXUS_ARTIFACT_NAME }}
        # Data folder is skipped for mod managers
        path: ${{github.workspace}}/build/nexus/sp/data/*

    - uses: actions/upload-artifact@v4
      with:
        name: papyrus-vm-nexus (${{ inputs.DESCRIPTION }})
        # Data folder is skipped for mod managers
        path: ${{github.workspace}}/build/nexus/papyrus-vm/*

    - name: Debug - free space
      if: runner.os == 'Windows'
      uses: actions/github-script@v6
      with:
        script: |
          const { execSync } = require('child_process');
          const output = execSync('Get-PSDrive', { encoding: 'utf8', shell: 'powershell' });
          console.log(output);

    - uses: actions/upload-artifact@v4
      with:
        name: msbuild_files (${{ inputs.DESCRIPTION }})
        path: |
          ${{github.workspace}}/build/**/*.sln
          ${{github.workspace}}/build/**/*.vcxproj
